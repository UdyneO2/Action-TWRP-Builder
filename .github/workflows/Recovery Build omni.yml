name: Builder TWRP Legacy (Omni)

on:
  workflow_dispatch:
    inputs:
      MANIFEST_URL:
        description: 'MANIFEST_URL'
        required: true
        default: 'https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni'
      MANIFEST_BRANCH:
        description: 'MANIFEST_BRANCH'
        required: true
        default: 'twrp-7.1'
      DEVICE_TREE_URL:
        description: 'DEVICE_TREE_URL'
        required: true
        default: 'https://github.com/UdyneO2/TWRP_SM-P355'
      DEVICE_TREE_BRANCH:
        description: 'DEVICE_TREE_BRANCH'
        required: true
        default: 'twrp-7.1'
      DEVICE_PATH:
        description: 'DEVICE_PATH'
        required: true
        default: 'device/samsung/gt5note8lte'
      COMMON_TREE_URL:
        description: 'COMMON_TREE_URL (if no common tree, leave blank)'
        required: false
        default: ''
      COMMON_PATH:
        description: 'COMMON_PATH (if no common tree, leave blank)'
        required: false
        default: ''
      DEVICE_NAME:
        description: 'DEVICE_NAME'
        required: true
        default: 'gt5note8lte'
      MAKEFILE_NAME:
        description: 'MAKEFILE_NAME'
        required: true
        default: 'omni_gt5note8lte'
      BUILD_TARGET:
        description: 'BUILD_TARGET'
        required: true
        default: 'recovery'

jobs:
  build:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    strategy:
      fail-fast: false
    
    steps:
    - name: Display Run Parameters
      run: |
        echo "::group::Build Parameters"
        echo "Manifest URL: ${{ github.event.inputs.MANIFEST_URL }}"
        echo "Manifest Branch: ${{ github.event.inputs.MANIFEST_BRANCH }}"
        echo "Device Tree URL: ${{ github.event.inputs.DEVICE_TREE_URL }}"
        echo "Device Tree Branch: ${{ github.event.inputs.DEVICE_TREE_BRANCH }}"
        echo "Device Path: ${{ github.event.inputs.DEVICE_PATH }}"
        echo "Device Name: ${{ github.event.inputs.DEVICE_NAME }}"
        echo "Makefile Name: ${{ github.event.inputs.MAKEFILE_NAME }}"
        echo "Build Target: ${{ github.event.inputs.BUILD_TARGET }}"
        echo "::endgroup::"

    - name: Check Out
      uses: actions/checkout@v4

    #- name: Clean Workspace
     # run: |
     #   sudo rm -rf /usr/local/lib/android || true
      #  sudo rm -rf /usr/share/dotnet || true
      #  sudo rm -rf /opt/ghc || true
      #  sudo rm -rf "/opt/microsoft/powershell" || true
      #  sudo rm -rf /opt/hostedtoolcache || true

    - name: Install Dependencies (Fixed for Ubuntu 22.04)
      run: |
        sudo apt-get update -y
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
        sudo dpkg --add-architecture i386
        sudo apt-get update -y
        sudo apt-get install -y \
        git-core gnupg flex bison build-essential zip curl \
        zlib1g-dev gcc-10-multilib g++-10-multilib gcc-multilib \
        g++-multilib libc6-dev-i386 lib32ncurses-dev \
        x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev \
        libxml2-utils xsltproc unzip fontconfig python2 python3 \
        adb fastboot bc ccache liblz4-tool libncurses5 libssl-dev \
        libsdl1.2-dev libwxgtk3.0-gtk3-dev libxml2 lzop pngcrush \
        schedtool squashfs-tools rsync libswitch-perl libstdc++6 \
        lib32stdc++6 libc6:i386 libstdc++6:i386 libz1:i386 \
        openjdk-8-jdk openjdk-8-jre
        
    - name: Install Java 8 
      run: |
        sudo apt-get install -y openjdk-8-jdk openjdk-8-jre
        sudo update-alternatives --set java /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java
        sudo update-alternatives --set javac /usr/lib/jvm/java-8-openjdk-amd64/bin/javac
        echo "JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64" >> $GITHUB_ENV
        echo "PATH=/usr/lib/jvm/java-8-openjdk-amd64/bin:$PATH" >> $GITHUB_ENV

    - name: Verify Java Version
      run: |
        echo "Java version:"
        java -version
        echo "Javac version:"
        javac -version
        echo "JAVA_HOME: $JAVA_HOME"

    - name: Setup SSH Keys (if using SSH URLs)
      if: ${{ startsWith(github.event.inputs.MANIFEST_URL, 'git@') || 
            startsWith(github.event.inputs.DEVICE_TREE_URL, 'git@') ||
            (github.event.inputs.COMMON_TREE_URL != '' && startsWith(github.event.inputs.COMMON_TREE_URL, 'git@')) }}
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Install repo tool
      run: |
        mkdir -p ~/bin
        curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        sudo cp ~/bin/repo /usr/local/bin/
        echo 'export PATH="$HOME/bin:$PATH"' >> ~/.bashrc

    - name: Initialize Workspace
      run: |
        mkdir -p twrp-build
        cd twrp-build
        echo "workspace=$(pwd)" >> $GITHUB_ENV
        git config --global user.name "github-actions"
        git config --global user.email "udyneos@github.com"
        git config --global color.ui false
        
        # Initialize repo with minimal sync
        repo init \
          -u ${{ github.event.inputs.MANIFEST_URL }} \
          -b ${{ github.event.inputs.MANIFEST_BRANCH }} \
          --depth=1 \
          --groups=all,-notdefault,-device,-darwin,-x86,-mips,-exynos5

    - name: Sync Repository
      run: |
        cd ${{ env.workspace }}
        repo sync -c -j$(nproc --all) \
          --force-sync \
          --no-clone-bundle \
          --no-tags \
          --optimized-fetch
      timeout-minutes: 30

    - name: Clone Device Tree
      run: |
        cd ${{ env.workspace }}
        mkdir -p $(dirname ${{ github.event.inputs.DEVICE_PATH }})
        git clone \
          ${{ github.event.inputs.DEVICE_TREE_URL }} \
          -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} \
          ${{ github.event.inputs.DEVICE_PATH }} \
          --depth=1

    - name: Clone Common Tree (if provided)
      if: ${{ github.event.inputs.COMMON_TREE_URL != '' && github.event.inputs.COMMON_PATH != '' }}
      run: |
        cd ${{ env.workspace }}
        mkdir -p $(dirname ${{ github.event.inputs.COMMON_PATH }})
        git clone \
          ${{ github.event.inputs.COMMON_TREE_URL }} \
          -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} \
          ${{ github.event.inputs.COMMON_PATH }} \
          --depth=1

    - name: Setup Python 2 
      run: |
        sudo apt-get install -y python2
        # Setup python2 as default python
        sudo update-alternatives --install /usr/bin/python python /usr/bin/python2 1
        sudo update-alternatives --install /usr/bin/python python /usr/bin/python3 2
        sudo update-alternatives --set python /usr/bin/python2
        python --version

    - name: Set Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 12

    - name: Setup Build Environment
      run: |
        cd ${{ env.workspace }}
        source build/envsetup.sh
        
        # Set necessary environment variables
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C
        export USE_CCACHE=1
        export CCACHE_EXEC=$(which ccache)
        ccache -M 50G
        ccache -o compression=true

    - name: Prepare Device Configuration
      run: |
        cd ${{ env.workspace }}
        # Check if device tree has proper setup
        if [ -f "${{ github.event.inputs.DEVICE_PATH }}/vendorsetup.sh" ]; then
          echo "vendorsetup.sh exists"
        else
          echo "Creating vendorsetup.sh"
          echo "add_lunch_combo ${{ github.event.inputs.MAKEFILE_NAME }}-eng" > ${{ github.event.inputs.DEVICE_PATH }}/vendorsetup.sh
        fi
        
        # Check BoardConfig.mk
        if [ ! -f "${{ github.event.inputs.DEVICE_PATH }}/BoardConfig.mk" ]; then
          echo "ERROR: BoardConfig.mk not found in device tree!"
          exit 1
        fi

    - name: Build Recovery
      run: |
        cd ${{ env.workspace }}
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        
        # Lunch and build
        lunch ${{ github.event.inputs.MAKEFILE_NAME }}-eng
        
        # Clean previous builds
        make clean
        
        # Build recovery
        if [ "${{ github.event.inputs.BUILD_TARGET }}" = "boot" ]; then
          make bootimage -j$(($(nproc)/2))
        else
          make recoveryimage -j$(($(nproc)/2))
        fi
        
        # Also try to build recovery zip
        make -j$(($(nproc)/2)) || true
      timeout-minutes: 120

    - name: List Output Files
      run: |
        cd ${{ env.workspace }}
        echo "::group::Build Output Directory"
        find out/target/product/${{ github.event.inputs.DEVICE_NAME }} -type f -name "*.img" -o -name "*.zip" -o -name "*.tar" | sort
        echo "::endgroup::"

    - name: Upload Recovery Image
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: recovery-${{ github.event.inputs.DEVICE_NAME }}
        path: |
          ${{ env.workspace }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/recovery.img
          ${{ env.workspace }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.zip
          ${{ env.workspace }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.tar
        if-no-files-found: error
        retention-days: 7

    - name: Create GitHub Release
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.workspace }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*twrp*.zip
          ${{ env.workspace }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.img
          ${{ env.workspace }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.tar
          
        name: TWRP-${{ github.event.inputs.DEVICE_NAME }}-${{ github.run_number }}
        tag_name: twrp-${{ github.event.inputs.DEVICE_NAME }}
        body: |
          # TWRP ${{  github.event.inputs.DEVICE_TREE_BRANCH }} Build for ${{ github.event.inputs.DEVICE_NAME }}
          
          **Build Information:**
          - Device: ${{ github.event.inputs.DEVICE_NAME }}
          - Manifest: ${{ github.event.inputs.MANIFEST_BRANCH }}
          - Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          **Installation:**
          ```
          fastboot flash recovery recovery.img
          # or
          fastboot boot recovery.img
          ```
          
          **Device Tree:** [${{ github.event.inputs.DEVICE_TREE_URL }}](${{ github.event.inputs.DEVICE_TREE_URL }})
          
          **Notes:** Built by Github.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Build Failure Debug
      if: failure()
      run: |
        echo "::group::Build Failure Debug Info"
        echo "Checking workspace structure..."
        find ${{ env.workspace }} -type f -name "*.mk" | head -20
        echo ""
        echo "Checking device tree..."
        ls -la ${{ env.workspace }}/${{ github.event.inputs.DEVICE_PATH }}/
        echo ""
        echo "Last 50 lines of build log:"
        find ${{ env.workspace }}/out -name "*.log" -exec tail -50 {} \; 2>/dev/null || echo "No log files found"
        echo "::endgroup::"
